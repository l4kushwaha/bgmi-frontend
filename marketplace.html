(() => {

  /* ================= CONFIG ================= */
  const API_URL = "https://bgmi_marketplace_service.bgmi-gateway.workers.dev/api";

  const container = document.getElementById("items-container");
  const searchInput = document.getElementById("search");
  const filterSelect = document.getElementById("filter");

  let listings = [];
  let currentListingId = null;

  /* ================= UTILS ================= */
  const safeArray = v => {
    try {
      if (Array.isArray(v)) return v;
      if (typeof v === "string") return JSON.parse(v);
      return [];
    } catch {
      return [];
    }
  };

  const renderStars = rating => {
    const r = Math.round(Number(rating) || 0);
    return "★".repeat(r) + "☆".repeat(5 - r);
  };

  const toast = (msg, ok = true) => {
    const t = document.getElementById("toast");
    if (!t) return;
    t.textContent = msg;
    t.style.background = ok ? "#27ae60" : "#c0392b";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
  };

  const session = () => {
    try {
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "null");
      if (!token || !user) return null;
      return { token, user };
    } catch {
      return null;
    }
  };

  /* ================= LOAD LISTINGS ================= */
  async function loadListings() {
    container.innerHTML = "";
    try {
      const s = session();
      const res = await fetch(`${API_URL}/listings`, {
        headers: s ? { Authorization: `Bearer ${s.token}` } : {}
      });

      listings = await res.json();
      if (!Array.isArray(listings)) listings = [];

      renderListings(listings);
    } catch {
      toast("Failed to load listings", false);
    }
  }

  /* ================= RENDER LISTINGS ================= */
  function renderListings(items) {
    container.innerHTML = "";

    const query = searchInput.value.toLowerCase();
    let filtered = items.filter(i =>
      `${i.title} ${i.uid} ${i.highest_rank}`.toLowerCase().includes(query)
    );

    if (filterSelect.value === "own") {
      const s = session();
      if (s) filtered = filtered.filter(i => i.seller_id == s.user.seller_id);
    }

    if (!filtered.length) {
      container.innerHTML = `<p>No listings found</p>`;
      return;
    }

    filtered.forEach(item => {
      const card = document.createElement("div");
      card.className = "item-card show";

      const images = safeArray(item.images);
      const mythic = safeArray(item.mythic_items);
      const legendary = safeArray(item.legendary_items);
      const gifts = safeArray(item.gift_items);
      const guns = safeArray(item.upgraded_guns);
      const titles = safeArray(item.titles);

      card.innerHTML = `
        <div class="rating-badge">${renderStars(item.avg_rating)}</div>

        <div class="verified-badge">
          ${item.seller_verified == 1 ? "Verified" : "Pending"}
        </div>

        ${item.badge ? `<div class="badge-badge">${item.badge}</div>` : ""}

        <div class="item-info">
          <strong>${item.title}</strong><br>
          UID: ${item.uid}<br>
          Level: ${item.level}<br>
          Rank: ${item.highest_rank || "-"}<br>

          ${guns.length ? `Upgraded Guns: ${guns.join(", ")}<br>` : ""}
          ${mythic.length ? `Mythic: ${mythic.join(", ")}<br>` : ""}
          ${legendary.length ? `Legendary: ${legendary.join(", ")}<br>` : ""}
          ${titles.length ? `Titles: ${titles.join(", ")}<br>` : ""}
          ${gifts.length ? `Gifts: ${gifts.join(", ")}<br>` : ""}

          <div class="price">₹${item.price}</div>
        </div>

        ${images.length ? `
          <div class="images-gallery">
            ${images.map(img => `<img src="${img}" onclick="openImage('${img}')">`).join("")}
          </div>` : ""}

        <button class="btn buy-btn" ${item.status !== "available" ? "disabled" : ""}>
          ${item.status === "available" ? "Buy" : "Sold"}
        </button>

        <button class="btn outline seller-btn">Seller Profile</button>
        <button class="btn edit-btn">Edit</button>
      `;

      /* EVENTS */
      card.querySelector(".seller-btn").onclick = () =>
        openSellerProfile(item.seller_id);

      card.querySelector(".edit-btn").onclick = () =>
        openEdit(item.id);

      container.appendChild(card);
    });
  }

  /* ================= IMAGE PREVIEW ================= */
  window.openImage = src => {
    const modal = document.getElementById("imgModal");
    document.getElementById("imgPreview").src = src;
    modal.classList.add("active");
  };

  /* ================= EDIT LISTING ================= */
  function openEdit(id) {
    currentListingId = id;
    const item = listings.find(l => l.id == id);
    if (!item) return toast("Listing not found", false);

    const form = document.getElementById("edit-form");
    document.getElementById("edit-modal-bg").classList.add("active");

    const arr = v => safeArray(v).join(", ");

    form.innerHTML = `
      <input id="e-title" value="${item.title}">
      <input id="e-price" type="number" value="${item.price}">
      <input id="e-level" type="number" value="${item.level}">
      <input id="e-rank" value="${item.highest_rank || ""}">
      <textarea id="e-guns">${arr(item.upgraded_guns)}</textarea>
      <textarea id="e-mythic">${arr(item.mythic_items)}</textarea>
      <textarea id="e-legendary">${arr(item.legendary_items)}</textarea>
      <textarea id="e-gifts">${arr(item.gift_items)}</textarea>
    `;
  }

  window.closeEdit = () => {
    document.getElementById("edit-modal-bg").classList.remove("active");
  };

  document.getElementById("save-edit").onclick = async () => {
    if (!currentListingId) return;

    const s = session();
    if (!s) return toast("Login required", false);

    const body = {
      title: e("e-title"),
      price: Number(e("e-price")),
      level: Number(e("e-level")),
      highest_rank: e("e-rank"),
      upgraded_guns: csv("e-guns"),
      mythic_items: csv("e-mythic"),
      legendary_items: csv("e-legendary"),
      gift_items: csv("e-gifts")
    };

    try {
      await fetch(`${API_URL}/listings/${currentListingId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${s.token}`
        },
        body: JSON.stringify(body)
      });

      toast("Listing updated");
      closeEdit();
      loadListings();
    } catch {
      toast("Update failed", false);
    }
  };

  const e = id => document.getElementById(id).value;
  const csv = id => e(id).split(",").map(v => v.trim()).filter(Boolean);

  /* ================= SELLER PROFILE (UNCHANGED) ================= */
  window.openSellerProfile = async sellerId => {
    const bg = document.getElementById("seller-modal-bg");
    const content = document.getElementById("seller-content");
    bg.classList.add("active");
    content.innerHTML = "Loading...";

    const res = await fetch(`${API_URL}/seller/${sellerId}`);
    const s = await res.json();

    content.innerHTML = `
      <h3>${s.name}</h3>
      <p>${s.seller_verified == 1 ? "Verified" : "Pending"}</p>
      <p>Badge: ${s.badge || "None"}</p>
      <p>Rating: ${renderStars(s.avg_rating)}</p>
      <p>Total Sales: ${s.total_sales}</p>
      <p>Reviews: ${s.review_count}</p>
    `;
  };

  window.closeSeller = () =>
    document.getElementById("seller-modal-bg").classList.remove("active");

  /* ================= EVENTS ================= */
  searchInput.addEventListener("input", () => renderListings(listings));
  filterSelect.addEventListener("change", () => renderListings(listings));

  /* ================= INIT ================= */
  loadListings();

})();