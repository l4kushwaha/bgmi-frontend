<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BGMI Marketplace</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1abc9c, #3498db);
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  h1 { text-align: center; color: #fff; margin: 20px 0; }
  #items-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 20px; min-height: 200px; }
  .item-card { background: #fff; border-radius: 10px; width: 250px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; position: relative; transition: transform 0.2s; }
  .item-card:hover { transform: scale(1.03); }
  .item-info { padding: 10px; }
  .item-info strong { display: inline-block; width: 70px; }
  .highlight { margin: 5px 0; color: #e67e22; font-weight: bold; }
  .new-badge { position: absolute; top: 10px; left: 10px; background: #e74c3c; color: #fff; padding: 3px 6px; font-size: 12px; font-weight: bold; border-radius: 3px; }
  .buy-btn, .edit-btn { padding: 7px 12px; border-radius: 5px; border: none; cursor: pointer; margin-top: 5px; width: 100%; }
  .buy-btn { background: #27ae60; color: #fff; }
  .buy-btn:disabled { background: #95a5a6; cursor: not-allowed; }
  .edit-btn { background: #3498db; color: #fff; }
  #modal-bg { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
  #modal-bg.active { display: flex; }
  .modal-content { background: #fff; padding: 20px; border-radius: 10px; text-align: center; min-width: 300px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  .modal-content button { margin: 10px; padding: 7px 15px; border: none; border-radius: 5px; cursor: pointer; }
  #confirm-btn { background: #27ae60; color: #fff; }
  #cancel-btn { background: #c0392b; color: #fff; }
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #27ae60; color: #fff; padding: 10px 20px; border-radius: 20px; display: none; z-index: 1100; }
  #toast.show { display: block; animation: fadein 0.3s, fadeout 0.3s 2.7s; }
  @keyframes fadein { from {opacity:0;} to {opacity:1;} }
  @keyframes fadeout { from {opacity:1;} to {opacity:0;} }
  #search { display: block; width: 90%; max-width: 400px; margin: 20px auto; padding: 10px; border-radius: 25px; border: none; outline: none; font-size: 16px; }
</style>
</head>
<body>

<h1>BGMI Marketplace</h1>
<input type="text" id="search" placeholder="Search items...">
<div id="items-container">
  <p>Loading items...</p>
</div>

<div id="modal-bg">
  <div class="modal-content">
    <p id="modal-text">Confirm purchase?</p>
    <button id="confirm-btn">Confirm</button>
    <button id="cancel-btn">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<script>
const API_URL = "https://bgmi_marketplace_service.bgmi-gateway.workers.dev/api/market";
let selectedListingId = null;
let selectedAction = null; // "purchase" or "edit"

// ===== Check login =====
function checkLogin() {
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user") || "null");
  if (!token || !user) {
    alert("Please login first!");
    window.location.href = "login.html";
    return null;
  }
  return { token, user };
}

const session = checkLogin();
if (!session) throw new Error("Not logged in");
const JWT = session.token;
const USER = session.user;

// ===== Toast =====
function showToast(msg, success=true) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.background = success ? "#27ae60" : "#c0392b";
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ===== Render Listings =====
async function loadListings() {
  try {
    const res = await fetch(`${API_URL}/list`, {
      headers: { "Authorization": `Bearer ${JWT}` }
    });
    const items = await res.json();
    const container = document.getElementById("items-container");
    container.innerHTML = "";

    if (!items || items.length === 0) {
      container.innerHTML = "<p>No items available</p>";
      return;
    }

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "item-card";

      const isNew = item.status === "available";
      let buttonsHTML = '';
      
      if (item.status === "available") {
        buttonsHTML += `<button class="buy-btn" onclick="openModal(${item.id}, 'purchase')">Buy</button>`;
      } else {
        buttonsHTML += `<button class="buy-btn" disabled>Sold Out</button>`;
      }

      // If current user is seller or admin => allow edit
      if (USER.role === "admin" || USER.id === item.seller_id) {
        buttonsHTML += `<button class="edit-btn" onclick="openModal(${item.id}, 'edit')">Edit</button>`;
      }

      card.innerHTML = `
        ${isNew ? '<div class="new-badge">NEW</div>' : ''}
        <div class="item-info">
          <p><strong>Title:</strong> ${item.title || "N/A"}</p>
          <p><strong>UID:</strong> ${item.uid || "N/A"}</p>
          ${item.highlights ? `<p class="highlight">${item.highlights.join(", ")}</p>` : ""}
          <p class="highlight"><strong>Price:</strong> ₹${item.price || 0}</p>
          <p><strong>Status:</strong> ${item.status || "Available"}</p>
          ${buttonsHTML}
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    showToast("Failed to load items", false);
    document.getElementById("items-container").innerHTML = "<p>Failed to load items</p>";
  }
}

// ===== Modal =====
function openModal(id, action) {
  selectedListingId = id;
  selectedAction = action;
  const modalText = document.getElementById("modal-text");
  modalText.textContent = action === "purchase" ? "Confirm purchase?" : "Edit your listing?";
  document.getElementById("modal-bg").classList.add("active");

  // If edit, prompt for new price
  if (action === "edit") {
    const newPrice = prompt("Enter new price (₹):");
    if (newPrice !== null) updateListingPrice(id, parseInt(newPrice));
  }
}
document.getElementById("cancel-btn").addEventListener("click", () => {
  selectedListingId = null;
  selectedAction = null;
  document.getElementById("modal-bg").classList.remove("active");
});

document.getElementById("confirm-btn").addEventListener("click", async () => {
  if (!selectedListingId || !selectedAction) return;
  if (selectedAction === "purchase") {
    try {
      const res = await fetch(`${API_URL}/purchase/${selectedListingId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${JWT}` },
        body: JSON.stringify({ payment_method: "wallet" })
      });
      const data = await res.json();
      showToast(data.message || "Purchase successful");
      loadListings();
    } catch (err) {
      console.error(err);
      showToast("Purchase failed", false);
    }
  }
  selectedListingId = null;
  selectedAction = null;
  document.getElementById("modal-bg").classList.remove("active");
});

// ===== Update Listing Price =====
async function updateListingPrice(id, price) {
  if (!price || isNaN(price)) return showToast("Invalid price", false);
  try {
    const res = await fetch(`${API_URL}/update/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${JWT}` },
      body: JSON.stringify({ price })
    });
    const data = await res.json();
    showToast(data.message || "Price updated");
    loadListings();
  } catch (err) {
    console.error(err);
    showToast("Failed to update price", false);
  }
}

// ===== Search =====
document.getElementById("search").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  let found = false;
  document.querySelectorAll(".item-card").forEach(card => {
    const text = card.innerText.toLowerCase();
    if (text.includes(query)) {
      card.style.display = "block";
      found = true;
    } else card.style.display = "none";
  });
  if (!found) document.getElementById("items-container").innerHTML = "<p>No items found</p>";
});

// ===== Initial Load =====
loadListings();
</script>
</body>
</html>
