<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BGMI Marketplace</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1abc9c, #3498db);
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  h1 { text-align: center; color: #fff; margin: 20px 0; }

  #items-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    padding: 20px;
    min-height: 200px;
  }
  .item-card {
    background: #222;
    border-radius: 10px;
    width: 250px;
    color: #fff;
    overflow: hidden;
    position: relative;
    transition: transform 0.2s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  .item-card:hover { transform: scale(1.03); }
  .item-info { padding: 10px; }
  .item-info strong { display: inline-block; width: 70px; }
  .highlight { margin: 5px 0; color: #e67e22; font-weight: bold; }

  .new-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #e74c3c;
    color: #fff;
    padding: 3px 6px;
    font-size: 12px;
    font-weight: bold;
    border-radius: 3px;
  }

  .buy-btn {
    background: linear-gradient(135deg, #00ffff, #ff00ff);
    color: #fff;
    border: none;
    padding: 7px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
    width: 100%;
  }
  .buy-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
  }

  #modal-bg {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modal-bg.active { display: flex; }
  .modal-content {
    background: #111;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    min-width: 300px;
    color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }
  .modal-content button {
    margin: 10px;
    padding: 7px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #confirm-btn { background: #27ae60; color: #fff; }
  #cancel-btn { background: #c0392b; color: #fff; }

  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #27ae60;
    color: #fff;
    padding: 10px 20px;
    border-radius: 20px;
    display: none;
    z-index: 1100;
  }
  #toast.show { display: block; animation: fadein 0.3s, fadeout 0.3s 2.7s; }
  @keyframes fadein { from {opacity:0;} to {opacity:1;} }
  @keyframes fadeout { from {opacity:1;} to {opacity:0;} }

  #search {
    display: block;
    width: 90%;
    max-width: 400px;
    margin: 20px auto;
    padding: 10px;
    border-radius: 25px;
    border: none;
    outline: none;
    font-size: 16px;
  }

  /* Admin panel */
  #admin-panel {
    background: #111;
    color: #fff;
    padding: 15px;
    margin: 20px auto;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
  }
  #admin-panel input, #admin-panel textarea {
    width: 90%;
    padding: 5px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
  }
  #admin-panel button {
    padding: 7px 15px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #00ffff, #ff00ff);
    color: #fff;
    margin-top: 5px;
  }
</style>
</head>
<body>

<h1>BGMI Marketplace</h1>

<input type="text" id="search" placeholder="Search items...">
<div id="items-container">
  <p>Loading items...</p>
</div>

<!-- Purchase Modal -->
<div id="modal-bg">
  <div class="modal-content">
    <p>Confirm purchase?</p>
    <button id="confirm-btn">Confirm</button>
    <button id="cancel-btn">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Admin Panel -->
<div id="admin-panel">
  <h3>Admin Panel</h3>
  <input type="text" id="admin-jwt" placeholder="Enter Admin JWT"><br>
  <button id="admin-login-btn">Login as Admin</button>
  <hr>
  <h4>Create Listing</h4>
  <input type="text" id="admin-uid" placeholder="UID"><br>
  <input type="text" id="admin-title" placeholder="Title"><br>
  <textarea id="admin-desc" placeholder="Description"></textarea><br>
  <input type="number" id="admin-price" placeholder="Price"><br>
  <input type="text" id="admin-rank" placeholder="Rank"><br>
  <input type="number" id="admin-level" placeholder="Level"><br>
  <button id="admin-create-listing-btn">Create Listing</button>
</div>

<script>
const API_URL = "https://bgmi_marketplace_service.bgmi-gateway.workers.dev/api/market";
let selectedListingId = null;
let ADMIN_JWT = null;

// ===== Check Login =====
function checkLogin() {
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user") || "null");

  if (!token || !user) {
    alert("Please login first!");
    window.location.href = "login.html";
    return null;
  }
  return token;
}
const JWT = checkLogin();
if (!JWT) throw new Error("Not logged in");

// ===== Toast =====
function showToast(msg, success=true) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.background = success ? "#27ae60" : "#c0392b";
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

// ===== Load Listings =====
async function loadListings() {
  try {
    const res = await fetch(`${API_URL}/list`, { headers: { "Authorization": `Bearer ${JWT}` } });
    const items = await res.json();
    const container = document.getElementById("items-container");
    container.innerHTML = "";

    if (!items || items.length === 0) {
      container.innerHTML = "<p>No items available</p>";
      return;
    }

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "item-card";

      const highlightsText = item.highlights?.join(", ") || "";
      const isAvailable = item.status === "available";

      card.innerHTML = `
        ${isAvailable ? '<div class="new-badge">NEW</div>' : ''}
        <div class="item-info">
          <p><strong>Title:</strong> ${item.title}</p>
          <p><strong>UID:</strong> ${item.uid}</p>
          ${highlightsText ? `<p class="highlight">${highlightsText}</p>` : ""}
          <p class="highlight"><strong>Price:</strong> â‚¹${item.price}</p>
          <p><strong>Status:</strong> ${item.status}</p>
          <button class="buy-btn" ${!isAvailable ? "disabled" : ""} onclick="confirmPurchase(${item.id})">
            ${isAvailable ? "Buy" : "Sold Out"}
          </button>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    showToast("Failed to load items", false);
  }
}

// ===== Purchase =====
function confirmPurchase(id) {
  selectedListingId = id;
  document.getElementById("modal-bg").classList.add("active");
}
document.getElementById("cancel-btn").addEventListener("click", () => {
  selectedListingId = null;
  document.getElementById("modal-bg").classList.remove("active");
});
document.getElementById("confirm-btn").addEventListener("click", async () => {
  if (!selectedListingId) return;
  try {
    const res = await fetch(`${API_URL}/purchase/${selectedListingId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${JWT}`,
      },
      body: JSON.stringify({ payment_method: "wallet" })
    });
    const data = await res.json();
    showToast(data.message || "Purchase successful");
    selectedListingId = null;
    document.getElementById("modal-bg").classList.remove("active");
    loadListings();
  } catch (err) {
    console.error(err);
    showToast("Purchase failed", false);
  }
});

// ===== Search =====
document.getElementById("search").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  document.querySelectorAll(".item-card").forEach(card => {
    const text = card.innerText.toLowerCase();
    card.style.display = text.includes(query) ? "block" : "none";
  });
});

// ===== Admin =====
document.getElementById("admin-login-btn").addEventListener("click", () => {
  const token = document.getElementById("admin-jwt").value.trim();
  if (!token) return showToast("Enter Admin JWT", false);
  ADMIN_JWT = token;
  showToast("Admin logged in");
});

document.getElementById("admin-create-listing-btn").addEventListener("click", async () => {
  if (!ADMIN_JWT) return showToast("Login as Admin first", false);

  const body = {
    seller_id: "admin_user",
    uid: document.getElementById("admin-uid").value,
    title: document.getElementById("admin-title").value,
    description: document.getElementById("admin-desc").value,
    price: parseInt(document.getElementById("admin-price").value) || 0,
    rank: document.getElementById("admin-rank").value,
    level: parseInt(document.getElementById("admin-level").value) || 0,
    mythic_count:0, legendary_count:0, xsuit_count:0, gilt_count:0,
    honor_gilt_set:0, upgradable_guns:0, rare_glider:0, vehicle_skin:0, special_titles:0
  };

  try {
    const res = await fetch(`${API_URL}/create`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${ADMIN_JWT}`
      },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    showToast(data.message || "Listing created");
    loadListings();
  } catch (err) {
    console.error(err);
    showToast("Failed to create listing", false);
  }
});

// ===== Auto-refresh =====
setInterval(loadListings, 30000);

// ===== Initial Load =====
loadListings();
</script>
</body>
</html>
