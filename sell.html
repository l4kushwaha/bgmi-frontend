<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sell BGMI Account â€” Sell</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
  body{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background: url("https://i.ytimg.com/vi/aoV3MROF_OY/hq720.jpg") center/cover no-repeat;
    color:#fff; position:relative;
  }
  body::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,0.45);z-index:0}
  form{position:relative;z-index:2;width:520px;max-width:96%;padding:28px;border-radius:16px;
       background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12)}
  h2{color:#00ffff;text-shadow:0 0 6px #0ff;margin-bottom:12px;text-align:center}
  input,textarea,select,button{width:100%;padding:10px;border-radius:10px;border:none;outline:none;margin:8px 0}
  input,textarea{background:rgba(255,255,255,0.08);color:#fff}
  input::placeholder,textarea::placeholder{color:rgba(255,255,255,0.7)}
  button.primary{background:linear-gradient(135deg,#00ffff,#ff00ff);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12);cursor:pointer}
  #drop-area{border:2px dashed rgba(0,255,255,0.25);padding:14px;border-radius:10px;text-align:center;color:#0ff;cursor:pointer}
  #drop-area.hover{background:rgba(0,255,255,0.05)}
  #preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .preview-img{width:72px;height:72px;border-radius:8px;overflow:hidden;position:relative;border:1px solid rgba(0,255,255,0.15)}
  .preview-img img{width:100%;height:100%;object-fit:cover;display:block}
  .preview-img .x{position:absolute;top:4px;right:4px;background:#ff4d4d;color:#fff;border-radius:50%;width:18px;height:18px;line-height:18px;text-align:center;font-size:12px;cursor:pointer}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;padding:10px 16px;border-radius:20px;background:#27ae60;color:#fff;display:none;z-index:9999}
  #toast.err{background:#c0392b}
  #fullModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:1200;align-items:center;justify-content:center}
  #fullModal img{max-width:92%;max-height:92%;border-radius:10px}
  .helper-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  small.hint{color:rgba(255,255,255,0.7)}
  .muted{color:rgba(255,255,255,0.6);font-size:13px;margin-top:6px}
</style>
</head>
<body>

<form id="sellForm" autocomplete="off" novalidate>
  <h2>Sell Your BGMI Account</h2>

  <div>
    <label class="sr-only" for="uid">UID</label>
    <input id="uid" placeholder="BGMI UID (required)" required />
  </div>

  <div>
    <label class="sr-only" for="title">Title</label>
    <input id="title" placeholder="Account title (e.g. Elite Plat Account)" required />
  </div>

  <div style="display:flex;gap:8px">
    <input id="rank" placeholder="Rank (Gold/Platinum/etc.)" />
    <input id="level" type="number" placeholder="Level" />
  </div>

  <!-- stats -->
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
    <input id="mythic_count" type="number" placeholder="Mythic" />
    <input id="legendary_count" type="number" placeholder="Legendary" />
    <input id="xsuit_count" type="number" placeholder="X-Suits" />
    <input id="gilt_count" type="number" placeholder="Gilt" />
    <input id="honor_gilt_set" type="number" placeholder="Honor Gilt Set" />
    <input id="upgradable_guns" type="number" placeholder="Upgradable Guns" />
    <input id="rare_glider" type="number" placeholder="Rare Glider" />
    <input id="vehicle_skin" type="number" placeholder="Vehicle Skin" />
    <input id="special_titles" type="number" placeholder="Special Titles" />
  </div>

  <div>
    <input id="highlights" placeholder="Highlights (comma separated)" />
  </div>

  <!-- drag & drop -->
  <div id="drop-area" tabindex="0">
    <input id="fileElem" type="file" multiple accept="image/*" style="display:none"/>
    Drag & drop images here or click to upload (optional)
  </div>
  <div id="preview" aria-live="polite"></div>

  <div class="helper-row" style="margin-top:8px">
    <div style="flex:1">
      <button type="button" id="estimateBtn" class="ghost">Estimate Price</button>
      <div id="estimatedPrice" class="muted"></div>
    </div>
    <div style="width:160px">
      <button type="submit" id="submitBtn" class="primary">List for Sale</button>
    </div>
  </div>

  <div class="muted" style="margin-top:10px">
    <small>Note: you must be logged in. This page uses the 'token' key from localStorage.</small>
  </div>
</form>

<div id="toast" role="status" aria-live="polite"></div>

<div id="fullModal" onclick="document.getElementById('fullModal').style.display='none'">
  <img id="modalImg" alt="preview"/>
</div>

<script>
(() => {
  // Configuration
  const API_BASE = "https://bgmi_marketplace_service.bgmi-gateway.workers.dev/api/listings";
  const form = document.getElementById('sellForm');
  const estimateBtn = document.getElementById('estimateBtn');
  const submitBtn = document.getElementById('submitBtn');
  const dropArea = document.getElementById('drop-area');
  const fileElem = document.getElementById('fileElem');
  const preview = document.getElementById('preview');
  const toastEl = document.getElementById('toast');

  // Session: use localStorage key 'token' (that's what you store)
  function getSession() {
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    return token && user ? { token, user } : null;
  }

  const session = getSession();
  if (!session) {
    alert('Login required!');
    window.location.href = 'login.html';
    return;
  }
  console.log('âœ… User logged in:', session.user.name || session.user.id);
  console.log('JWT Token:', session.token);

  // Toast helper
  function showToast(msg, isError=false) {
    toastEl.textContent = msg;
    toastEl.className = isError ? 'err' : '';
    toastEl.style.display = 'block';
    setTimeout(()=> { toastEl.style.display = 'none'; }, 3000);
  }

  // --- Estimate logic (client-side quick estimate) ---
  function estimateValue() {
    const fields = ["level","mythic_count","legendary_count","xsuit_count","gilt_count","honor_gilt_set","upgradable_guns","rare_glider","vehicle_skin","special_titles"];
    let price = 0;
    fields.forEach(f => {
      const v = parseInt(document.getElementById(f).value) || 0;
      switch(f) {
        case "level": price += v*10; break;
        case "mythic_count": price += v*500; break;
        case "legendary_count": price += v*300; break;
        case "xsuit_count": price += v*2000; break;
        case "gilt_count": price += v*150; break;
        case "honor_gilt_set": price += v*200; break;
        case "upgradable_guns": price += v*100; break;
        case "rare_glider": price += v*150; break;
        case "vehicle_skin": price += v*100; break;
        case "special_titles": price += v*200; break;
      }
    });
    document.getElementById('estimatedPrice').innerText = `ðŸ’° Estimated Value: â‚¹${price}`;
  }
  estimateBtn.addEventListener('click', estimateValue);

  // --- Drag & drop images ---
  let uploaded = [];
  function handleFiles(files) {
    for (const file of files) {
      if (!file.type.startsWith('image/')) { showToast('Only images allowed', true); continue; }
      const reader = new FileReader();
      reader.onload = (e) => {
        uploaded.push(e.target.result);
        renderPreview();
      };
      reader.readAsDataURL(file);
    }
  }
  function renderPreview(){
    preview.innerHTML = '';
    uploaded.forEach((src, idx) => {
      const div = document.createElement('div');
      div.className='preview-img';
      const img = document.createElement('img');
      img.src = src; img.alt = 'preview ' + (idx+1);
      img.addEventListener('click', ()=> {
        document.getElementById('modalImg').src = src;
        document.getElementById('fullModal').style.display = 'flex';
      });
      const x = document.createElement('div'); x.className='x'; x.textContent='Ã—';
      x.addEventListener('click', ()=> { uploaded.splice(idx,1); renderPreview(); });
      div.appendChild(img); div.appendChild(x);
      preview.appendChild(div);
    });
  }

  dropArea.addEventListener('click', ()=> fileElem.click());
  dropArea.addEventListener('dragover', (e)=> { e.preventDefault(); dropArea.classList.add('hover'); });
  dropArea.addEventListener('dragleave', (e)=> { e.preventDefault(); dropArea.classList.remove('hover'); });
  dropArea.addEventListener('drop', (e)=> { e.preventDefault(); dropArea.classList.remove('hover'); handleFiles(e.dataTransfer.files); });
  fileElem.addEventListener('change', (e)=> handleFiles(e.target.files));

  // --- Form submission ---
  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if (!session) { showToast('Login required', true); return; }

    // collect payload
    const payload = {
      seller_id: session.user.id || session.user.username || String(session.user.id || 'unknown'),
      uid: document.getElementById('uid').value.trim(),
      title: document.getElementById('title').value.trim(),
      description: document.getElementById('highlights').value.trim(),
      rank: document.getElementById('rank').value.trim(),
      level: parseInt(document.getElementById('level').value) || 0,
      mythic_count: parseInt(document.getElementById('mythic_count').value)||0,
      legendary_count: parseInt(document.getElementById('legendary_count').value)||0,
      xsuit_count: parseInt(document.getElementById('xsuit_count').value)||0,
      gilt_count: parseInt(document.getElementById('gilt_count').value)||0,
      honor_gilt_set: parseInt(document.getElementById('honor_gilt_set').value)||0,
      upgradable_guns: parseInt(document.getElementById('upgradable_guns').value)||0,
      rare_glider: parseInt(document.getElementById('rare_glider').value)||0,
      vehicle_skin: parseInt(document.getElementById('vehicle_skin').value)||0,
      special_titles: parseInt(document.getElementById('special_titles').value)||0,
      images: uploaded.length ? uploaded : ["https://via.placeholder.com/250x150?text=No+Image"]
    };

    // basic validation
    if (!payload.uid || !payload.title) { showToast('UID and Title are required', true); return; }

    // disable submit while request in progress
    submitBtn.disabled = true;
    submitBtn.textContent = 'Listing...';

    try {
      const res = await fetch(`${API_BASE}/create`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.token}`
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=>({}));

      if (res.ok) {
        showToast('ðŸŽ‰ Account listed successfully');
        form.reset(); uploaded=[]; renderPreview();
        document.getElementById('estimatedPrice').innerText = '';
      } else {
        // handle specific server responses
        console.error('Server returned', res.status, data);
        if (res.status === 401) {
          showToast('Unauthorized â€” please login again', true);
          // optionally redirect to login
          setTimeout(()=> window.location.href = 'login.html', 800);
        } else if (res.status === 500) {
          // show helpful debug info and offer console-test fallback
          const details = data.details || data.error || 'Internal Server Error';
          showToast('Server error: ' + (data.message || 'Internal Server Error'), true);
          console.warn('Server details:', details);

          // If error looks like FK failure, show a helper button to try console_test creation
          if (String(details).toLowerCase().includes('foreign key') || String(details).toLowerCase().includes('foreign')) {
            // create a quick on-screen helper to try console test creation
            const helper = document.createElement('div');
            helper.style.marginTop = '10px';
            helper.innerHTML = `
              <div style="color:#fff;background:rgba(0,0,0,0.3);padding:10px;border-radius:8px">
                <div style="margin-bottom:8px">Your account may not exist in the marketplace DB yet (foreign key failed).</div>
                <button id="consoleTestBtn" class="ghost" style="width:auto">Try create via Console Test (bypass)</button>
              </div>
            `;
            form.appendChild(helper);
            const btn = document.getElementById('consoleTestBtn');
            btn.addEventListener('click', async () => {
              btn.disabled = true; btn.textContent = 'Creating...';
              try {
                const r2 = await fetch(`${API_BASE}/create?console_test=1`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                const d2 = await r2.json().catch(()=>({}));
                if (r2.ok) { showToast('Created (console test) âœ…'); console.log(d2); helper.remove(); }
                else { showToast('Console create failed: ' + (d2.error || d2.message || r2.status), true); console.warn(d2); }
              } catch(err) { console.error(err); showToast('Console create network error', true); }
            });
          }
        } else {
          showToast(data.error || data.message || 'Failed to list account', true);
        }
      }
    } catch (err) {
      console.error('Request failed', err);
      showToast('Network request failed', true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'List for Sale';
    }
  });

})();
</script>
</body>
</html>
