<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sell BGMI Account üíé</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ==== Basic Reset ==== */
* { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins", sans-serif; }
body {
  min-height:100vh;
  background: url("https://i.ytimg.com/vi/aoV3MROF_OY/hq720.jpg?sqp=-oaymwEhCK4FEIIDSFryq4qpAxMIARUAAAAAGAElAADIQj0AgKJD&rs=AOn4CLCTHZ0jtDKlIZ1O0UfD9GytpmtpXQ") 
    no-repeat center center/cover;
  display:flex; justify-content:center; align-items:center; position:relative; color:#fff;
}
body::before { content:""; position:absolute; inset:0; background: rgba(0,0,0,0.45); z-index:0; }

/* ==== Form ==== */
form {
  position:relative; z-index:2; width:480px; max-width:95%; padding:30px; border-radius:25px;
  background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.25);
  box-shadow: 0 0 40px rgba(0,255,255,0.2);
}
h2 { text-align:center; font-weight:700; font-size:1.6em; margin-bottom:18px; color:#00ffff;
  text-shadow:0 0 10px #0ff,0 0 20px #ff00ff,0 0 30px #00ffff;
}
input, button, textarea { width:100%; padding:12px; border-radius:12px; margin:10px 0; font-size:14px; border:none; outline:none; }
input { background: rgba(255,255,255,0.12); color:white; }
input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.7); }
input:focus, textarea:focus { background: rgba(255,255,255,0.25); box-shadow:0 0 15px rgba(0,255,255,0.6); }
button { background: linear-gradient(135deg,#00ffff,#ff00ff); color:#fff; font-weight:700; cursor:pointer; }
#estimatedPrice { text-align:center; color:#00ffff; font-weight:bold; margin:10px 0; text-shadow:0 0 10px #0ff; }

/* ==== Toast ==== */
#toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: #27ae60; color: #fff; padding: 10px 20px; border-radius: 20px;
  display: none; z-index: 1100;
}
#toast.show { display: block; animation: fadein 0.3s, fadeout 0.3s 2.7s; }
@keyframes fadein { from {opacity:0;} to {opacity:1;} }
@keyframes fadeout { from {opacity:1;} to {opacity:0;} }

/* ==== Drag & Drop ==== */
#drop-area { border: 2px dashed #0ff; border-radius: 12px; padding: 20px; text-align: center; color: #0ff; margin:10px 0; cursor: pointer; }
#drop-area.hover { background: rgba(0,255,255,0.1); }
#preview { margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.preview-img { width: 80px; height:80px; object-fit:cover; border-radius:12px; border:1px solid #0ff; position:relative; cursor:pointer; }
.preview-img span { position:absolute; top:2px; right:2px; background:red; color:#fff; font-size:12px; border-radius:50%; width:18px; height:18px; text-align:center; line-height:18px; cursor:pointer; }
.preview-img .number { position:absolute; bottom:2px; left:2px; background:rgba(0,255,255,0.7); color:#000; font-size:12px; border-radius:6px; width:18px; height:18px; text-align:center; line-height:18px; }
.preview-img.dragging { opacity:0.5; }

/* ==== Fullscreen Modal ==== */
#fullModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1200; justify-content:center; align-items:center; }
#fullModal img { max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 0 20px #0ff; }
#fullModal span { position:absolute; top:20px; right:30px; font-size:30px; color:#fff; cursor:pointer; }

/* ==== Accessibility: visually hidden labels ==== */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}
</style>
</head>
<body>

<form id="sellForm">
  <h2>Sell Your BGMI Account</h2>

  <div class="form-group">
    <label for="uid" class="sr-only">BGMI UID</label>
    <input type="text" id="uid" placeholder="BGMI UID" required>
  </div>

  <div class="form-group">
    <label for="title" class="sr-only">Account Title</label>
    <input type="text" id="title" placeholder="Account Title" required>
  </div>

  <div class="form-group">
    <label for="rank" class="sr-only">Account Rank</label>
    <input type="text" id="rank" placeholder="Account Rank" required>
  </div>

  <div class="form-group">
    <label for="level" class="sr-only">Account Level</label>
    <input type="number" id="level" placeholder="Account Level" required>
  </div>

  <!-- Additional attributes -->
  <div class="form-group"><label class="sr-only" for="mythic_count">Mythic Count</label><input type="number" id="mythic_count" placeholder="Mythic Items Count"></div>
  <div class="form-group"><label class="sr-only" for="legendary_count">Legendary Count</label><input type="number" id="legendary_count" placeholder="Legendary Items Count"></div>
  <div class="form-group"><label class="sr-only" for="xsuit_count">X-Suits Count</label><input type="number" id="xsuit_count" placeholder="X-Suits Count"></div>
  <div class="form-group"><label class="sr-only" for="gilt_count">Gilt Count</label><input type="number" id="gilt_count" placeholder="Gilt Count"></div>
  <div class="form-group"><label class="sr-only" for="honor_gilt_set">Honor Gilt Set</label><input type="number" id="honor_gilt_set" placeholder="Honor Gilt Set"></div>
  <div class="form-group"><label class="sr-only" for="upgradable_guns">Upgradable Guns</label><input type="number" id="upgradable_guns" placeholder="Upgradable Guns"></div>
  <div class="form-group"><label class="sr-only" for="rare_glider">Rare Glider</label><input type="number" id="rare_glider" placeholder="Rare Glider"></div>
  <div class="form-group"><label class="sr-only" for="vehicle_skin">Vehicle Skin</label><input type="number" id="vehicle_skin" placeholder="Vehicle Skin"></div>
  <div class="form-group"><label class="sr-only" for="special_titles">Special Titles</label><input type="number" id="special_titles" placeholder="Special Titles"></div>
  <div class="form-group"><label class="sr-only" for="highlights">Highlights</label><input type="text" id="highlights" placeholder="Highlights (comma separated)"></div>

  <!-- Drag & Drop Images -->
  <div id="drop-area" tabindex="0">Drag & Drop Images Here or Click to Upload
    <input type="file" id="fileElem" multiple style="display:none;">
  </div>
  <div id="preview"></div>

  <button type="button" onclick="estimateValue()">Estimate Price</button>
  <div id="estimatedPrice"></div>
  <button type="submit">List for Sale</button>
</form>

<div id="toast"></div>
<div id="fullModal"><span onclick="closeModal()">√ó</span><img id="modalImg"></div>

<script>
const API_URL = "https://bgmi_marketplace_service.bgmi-gateway.workers.dev/api/market";
let uploadedImages = [];

// ===== Login Check =====
const token = localStorage.getItem("token");
const user = JSON.parse(localStorage.getItem("user") || "null");
if (!token || !user) {
  alert("Login required!");
  window.location.href = "login.html";
}

// ===== Toast =====
function showToast(msg, success=true){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.background = success ? "#27ae60" : "#c0392b";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

// ===== Estimate Price =====
function estimateValue() {
  const fields = ["level","mythic_count","legendary_count","xsuit_count","gilt_count","honor_gilt_set","upgradable_guns","rare_glider","vehicle_skin","special_titles"];
  let price=0;
  fields.forEach(f=>{
    const val = parseInt(document.getElementById(f).value)||0;
    switch(f){
      case "level": price+=val*10; break;
      case "mythic_count": price+=val*500; break;
      case "legendary_count": price+=val*300; break;
      case "xsuit_count": price+=val*2000; break;
      case "gilt_count": price+=val*150; break;
      case "honor_gilt_set": price+=val*200; break;
      case "upgradable_guns": price+=val*100; break;
      case "rare_glider": price+=val*150; break;
      case "vehicle_skin": price+=val*100; break;
      case "special_titles": price+=val*200; break;
    }
  });
  document.getElementById("estimatedPrice").innerText = `üí∞ Estimated Value: ‚Çπ${price}`;
}

// ===== Drag & Drop Images =====
const dropArea = document.getElementById("drop-area");
const fileInput = document.getElementById("fileElem");
const preview = document.getElementById("preview");

dropArea.addEventListener("click",()=>fileInput.click());
dropArea.addEventListener("dragover", e=>{ e.preventDefault(); dropArea.classList.add("hover"); });
dropArea.addEventListener("dragleave", e=>{ e.preventDefault(); dropArea.classList.remove("hover"); });
dropArea.addEventListener("drop", e=>{ e.preventDefault(); dropArea.classList.remove("hover"); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener("change", e=>handleFiles(e.target.files));

function handleFiles(files){
  for(let file of files){
    if(!file.type.startsWith("image/")) { showToast("‚ùå Only images allowed",false); continue; }
    const reader = new FileReader();
    reader.onload = e=>{ uploadedImages.push(e.target.result); updatePreview(); };
    reader.readAsDataURL(file);
  }
}

function updatePreview(){
  preview.innerHTML="";
  uploadedImages.forEach((img,index)=>{
    const div = document.createElement("div");
    div.className="preview-img";
    div.draggable=true;
    div.dataset.index=index;

    const imageElem=document.createElement("img");
    imageElem.src=img;
    imageElem.addEventListener("click", ()=>openModal(img));
    div.appendChild(imageElem);

    const del = document.createElement("span");
    del.innerText="√ó";
    del.addEventListener("click",()=>{ uploadedImages.splice(index,1); updatePreview(); });
    div.appendChild(del);

    const num = document.createElement("div");
    num.className="number";
    num.innerText=index+1;
    div.appendChild(num);

    preview.appendChild(div);
  });
}

// ===== Fullscreen Modal =====
function openModal(src){ document.getElementById("modalImg").src=src; document.getElementById("fullModal").style.display="flex"; }
function closeModal(){ document.getElementById("fullModal").style.display="none"; }

// ===== Form Submit =====
document.getElementById("sellForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const payload={
    seller_id:user?.username||user?.name||"admin_user",
    uid:document.getElementById("uid").value.trim(),
    title:document.getElementById("title").value.trim(),
    description:document.getElementById("highlights").value.trim(),
    rank:document.getElementById("rank").value.trim(),
    level:parseInt(document.getElementById("level").value)||0,
    mythic_count:parseInt(document.getElementById("mythic_count").value)||0,
    legendary_count:parseInt(document.getElementById("legendary_count").value)||0,
    xsuit_count:parseInt(document.getElementById("xsuit_count").value)||0,
    gilt_count:parseInt(document.getElementById("gilt_count").value)||0,
    honor_gilt_set:parseInt(document.getElementById("honor_gilt_set").value)||0,
    upgradable_guns:parseInt(document.getElementById("upgradable_guns").value)||0,
    rare_glider:parseInt(document.getElementById("rare_glider").value)||0,
    vehicle_skin:parseInt(document.getElementById("vehicle_skin").value)||0,
    special_titles:parseInt(document.getElementById("special_titles").value)||0,
    images:uploadedImages.length?uploadedImages:["https://via.placeholder.com/250x150?text=No+Image"]
  };

  try{
    const res=await fetch(`${API_URL}/create`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": `Bearer ${token}`
      },
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(res.ok){
      showToast("üéâ Account listed successfully!");
      document.getElementById("sellForm").reset();
      uploadedImages=[]; preview.innerHTML=""; document.getElementById("estimatedPrice").innerText="";
    }else throw new Error(data.error||"Failed to list account");
  }catch(err){ showToast("‚ùå "+err.message,false); }
});
</script>

</body>
</html>
