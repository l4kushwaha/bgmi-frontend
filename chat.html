<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BGMI Marketplace Chat</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: #fff;
    display: flex;
    height: 100vh;
  }

  #sidebar {
    width: 250px;
    background: #0b3d91;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }

  #searchContainer {
    display: flex;
    margin-bottom: 10px;
  }

  #searchInput {
    flex: 1;
    padding: 6px;
    border-radius: 4px;
    border: none;
    outline: none;
  }

  #searchBtn {
    margin-left: 5px;
    padding: 6px;
    background: #3aafa9;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  #userList {
    flex: 1;
    overflow-y: auto;
  }

  .userItem {
    padding: 8px;
    border-bottom: 1px solid #0a2d6b;
    cursor: pointer;
  }

  .userItem:hover {
    background: #0a2d6b;
  }

  #chatContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }

  #presence {
    margin-bottom: 5px;
  }

  #chatBox {
    flex: 1;
    background: #121212;
    border: 1px solid #333;
    padding: 10px;
    overflow-y: auto;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .message {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    max-width: 70%;
    word-wrap: break-word;
  }

  .sent {
    background: #2b7a78;
    align-self: flex-end;
  }

  .received {
    background: #17252a;
    align-self: flex-start;
  }

  .attachments a {
    display: block;
    color: #def2f1;
    text-decoration: underline;
    margin-top: 4px;
    font-size: 0.85em;
  }

  #inputContainer {
    display: flex;
    gap: 5px;
  }

  #messageInput {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: none;
    outline: none;
    font-size: 1em;
  }

  #attachments {
    width: 40px;
  }

  #sendBtn {
    padding: 10px 16px;
    background: #3aafa9;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
  }

  #sendBtn:hover {
    background: #2b7a78;
  }

  #chatPlaceholder {
    text-align: center;
    color: #aaa;
    margin-top: 20px;
  }
</style>
</head>
<body>

<div id="sidebar">
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search users..." />
    <button id="searchBtn">Go</button>
  </div>
  <div id="userList"></div>
</div>

<div id="chatContainer">
  <div id="presence">ðŸŸ¢ Online</div>
  <div id="chatBox"><p id="chatPlaceholder">Select a user to start chatting</p></div>
  <div id="inputContainer">
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <input type="file" id="attachments" multiple />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
  const API_BASE = "https://bgmi_chat_service.bgmi-gateway.workers.dev";
  const token = localStorage.getItem("token"); // JWT

  let room_id = null;
  let sse = null;

  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const userList = document.getElementById("userList");
  const messagesDiv = document.getElementById("chatBox");
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const attachInput = document.getElementById("attachments");
  const presenceDiv = document.getElementById("presence");

  function authHeaders() {
    return { "Content-Type": "application/json", Authorization: `Bearer ${token}` };
  }

  function addMessage(msg, mine=false) {
    const div = document.createElement("div");
    div.className = mine ? "sent message" : "received message";
    div.id = `msg-${msg.id || ""}`;

    let attachHTML = "";
    if (msg.attachments && msg.attachments.length > 0) {
      attachHTML = msg.attachments.map(a => `<a href="${a.file_url}" target="_blank">${a.file_url.split("/").pop()}</a>`).join("<br>");
    }

    div.innerHTML = `
      <span>${msg.message}</span>
      ${mine ? `<small>${msg.status || "sent"}</small>` : ""}
      <div class="attachments">${attachHTML}</div>
    `;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function searchUsers() {
    const q = searchInput.value.trim();
    if (!q) return;
    userList.innerHTML = "<p>Searching...</p>";

    const res = await fetch(`${API_BASE}/api/chat/users/search?q=${encodeURIComponent(q)}`, { headers: authHeaders() });
    const users = await res.json();

    userList.innerHTML = "";
    users.forEach(u => {
      const div = document.createElement("div");
      div.className = "userItem";
      div.textContent = `${u.username} (${u.email})`;
      div.onclick = async () => {
        const roomRes = await fetch(`${API_BASE}/internal/create-room`, {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ order_id: `room-${u.id}`, buyer_id: u.id, seller_id: u.id })
        });
        const roomData = await roomRes.json();
        openChat(`room-${u.id}`);
      };
      userList.appendChild(div);
    });
  }

  async function openChat(rid) {
    room_id = rid;
    messagesDiv.innerHTML = "<p id='chatPlaceholder'>Loading...</p>";

    const res = await fetch(`${API_BASE}/api/chat/messages?room_id=${room_id}`, { headers: authHeaders() });
    const data = await res.json();
    messagesDiv.innerHTML = "";
    data.forEach(m => addMessage(m, m.sender_id !== room_id));

    connectSSE();
    checkPresence();
  }

  async function sendMessage() {
    if (!room_id) return;
    const content = input.value.trim();
    if (!content && attachInput.files.length === 0) return;

    const attachments = Array.from(attachInput.files).map(f => ({
      url: URL.createObjectURL(f),
      mime_type: f.type
    }));

    input.value = "";
    attachInput.value = "";

    const body = { room_id, message: content, type: "text", attachments };

    const res = await fetch(`${API_BASE}/api/chat/send`, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify(body)
    });
    const data = await res.json();
    addMessage({ message: content, attachments, status: "sent", id: data.message_id }, true);
  }

  function connectSSE() {
    if (!room_id) return;
    if (sse) sse.close();

    sse = new EventSource(`${API_BASE}/api/chat/stream?room_id=${room_id}`);

    sse.onmessage = e => {
      const msg = JSON.parse(e.data);
      addMessage(msg, msg.sender_id !== room_id);
    };

    sse.onerror = () => {
      console.warn("SSE error, reconnecting in 3s");
      sse.close();
      setTimeout(connectSSE, 3000);
    };
  }

  async function checkPresence() {
    const res = await fetch(`${API_BASE}/api/user/presence`, { headers: authHeaders() });
    const data = await res.json();
    presenceDiv.textContent = data.online ? "ðŸŸ¢ Online" : "âš« Offline";
  }

  /* ===== EVENTS ===== */
  sendBtn.onclick = sendMessage;
  input.addEventListener("keypress", e => e.key === "Enter" && sendMessage());
  attachInput.addEventListener("change", () => input.focus());
  searchBtn.onclick = searchUsers;
  searchInput.addEventListener("keypress", e => e.key === "Enter" && searchUsers());
</script>

</body>
</html>
